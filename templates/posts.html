<!DOCTYPE html>
<html>
<head>
    <title>Serendyze - Reddit Posts</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="header">
        <h1>SERENDYZE</h1>
        <div class="user-info">
            Welcome, <span id="username">{{ username }}</span>!
        </div>
    </div>

    <div class="body-container">
        <div class="posts-container" id="postsContainer">
            {% for post in posts %}
            <div class="post-item" data-post-id="{{ post.id }}">
                <div class="post-header">
                    <span class="author">üë§ {{ post.author }}</span>
                    <span class="subreddit">r/{{ post.subreddit }}</span>
                </div>
                
                <a href="{{ post.url }}" class="post-link" target="_blank"
                   data-post-id="{{ post.id }}"
                   data-subreddit="{{ post.subreddit }}"
                   data-title="{{ post.title }}">
                    {{ post.title }}
                </a>

                <div class="post-details">
                    <div class="votes">
                        <span class="upvotes">‚¨ÜÔ∏è {{ post.ups }}</span>
                        <span class="rating">Rating: {{ post.rating }}/5</span>
                    </div>
                    <span class="comments">üí¨ {{ post.num_comments }} comments</span>
                </div>

                <div class="comments-section" style="display: none;">
                    <!-- Comments will be loaded here -->
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Track clicked posts
            const clickedPosts = new Set();

            // Handle post clicks
            document.querySelectorAll('.post-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    const postId = this.dataset.postId;
                    const postTitle = this.dataset.title;
                    const subreddit = this.dataset.subreddit;

                    // Mark as read
                    if (!clickedPosts.has(postId)) {
                        clickedPosts.add(postId);
                        this.closest('.post-item').classList.add('read');

                        // Log the click
                        fetch('/log_click', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                interaction_type: 'click',
                                post_id: postId,
                                post_title: postTitle,
                                subreddit: subreddit,
                                timestamp: new Date().toISOString(),
                                username: document.getElementById('username').textContent
                            })
                        });
                    }
                });
            });

            // Handle comments toggle
            document.querySelectorAll('.comments').forEach(commentsToggle => {
                commentsToggle.addEventListener('click', function() {
                    const postItem = this.closest('.post-item');
                    const postId = postItem.dataset.postId;
                    const commentsSection = postItem.querySelector('.comments-section');

                    if (commentsSection.style.display === 'none') {
                        // Fetch comments
                        fetch(`/comments/${postId}`, {
                            headers: {
                                'Authorization': localStorage.getItem('accessToken')
                            }
                        })
                        .then(response => response.json())
                        .then(comments => {
                            commentsSection.innerHTML = formatComments(comments);
                            commentsSection.style.display = 'block';
                        })
                        .catch(error => console.error('Error fetching comments:', error));
                    } else {
                        commentsSection.style.display = 'none';
                    }
                });
            });

            function formatComments(comments) {
                return comments.map(comment => `
                    <div class="comment" style="margin-left: ${comment.depth * 20}px">
                        <div class="comment-author">${comment.author}</div>
                        <div class="comment-body">${comment.body}</div>
                        <div class="comment-score">Score: ${comment.score}</div>
                    </div>
                `).join('');
            }
        });
    </script>
</body>
</html>